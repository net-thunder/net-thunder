package io.jaspercloud.sdwan;

import cn.hutool.core.util.HexUtil;
import io.jaspercloud.sdwan.tun.IpLayerPacket;
import io.jaspercloud.sdwan.tun.Ipv4Packet;
import io.jaspercloud.sdwan.tun.TcpPacket;
import io.jaspercloud.sdwan.util.ByteBufUtil;
import io.netty.buffer.ByteBuf;
import org.junit.jupiter.api.Test;

public class IpTest {

    @Test
    public void test() {
        String hex = "45000af088a740003b061d3ec0a80d59c0de0043" +
                "7977c4078e566a838c71be2f501000169a050000" +
                "4e2229282249455f50524f544f22292c633d66756e6374696f6e28297b7d2c753d66756e6374696f6e28297b76617220652c743d6e28226a68786622292822696672616d6522292c723d612e6c656e6774683b666f7228742e7374796c652e646973706c61793d226e6f6e65222c6e28226430373522292e617070656e644368696c642874292c742e7372633d226a6176617363726970743a222c653d742e636f6e74656e7457696e646f772e646f63756d656e742c652e6f70656e28292c652e777269746528223c7363726970743e646f63756d656e742e463d4f626a6563743c5c2f7363726970743e22292c652e636c6f736528292c753d652e463b722d2d3b2964656c65746520752e70726f746f747970655b615b725d5d3b72657475726e207528297d3b652e6578706f7274733d4f626a6563742e6372656174657c7c66756e6374696f6e28652c74297b766172206e3b72657475726e206e756c6c213d3d653f28632e70726f746f747970653d722865292c6e3d6e657720632c632e70726f746f747970653d6e756c6c2c6e5b695d3d65293a6e3d7528292c766f696420303d3d3d743f6e3a6f286e2c74297d7d2c22382b2b2f223a66756e6374696f6e28652c742c6e297b2275736520737472696374223b66756e6374696f6e20722865297b72657475726e2065213d3d657d652e6578706f7274733d727d2c22382f4552223a66756e6374696f6e28652c742c6e297b2275736520737472696374223b66756e6374696f6e20722865297b6966282266756e6374696f6e22213d747970656f66205765616b4d61702972657475726e206e756c6c3b76617220743d6e6577205765616b4d61702c6e3d6e6577205765616b4d61703b72657475726e28723d66756e6374696f6e2865297b72657475726e20653f6e3a747d292865297d66756e6374696f6e206f28652c74297b69662821742626652626652e5f5f65734d6f64756c652972657475726e20653b6966286e756c6c3d3d3d657c7c226f626a65637422213d747970656f66206526262266756e6374696f6e22213d747970656f6620652972657475726e7b64656661756c743a657d3b766172206e3d722874293b6966286e26266e2e6861732865292972657475726e206e2e6765742865293b766172206f3d7b7d2c613d4f626a6563742e646566696e6550726f706572747926264f626a6563742e6765744f776e50726f706572747944657363726970746f723b666f7228766172206920696e2065296966282264656661756c7422213d3d6926264f626a6563742e70726f746f747970652e6861734f776e50726f70657274792e63616c6c28652c6929297b76617220633d613f4f626a6563742e6765744f776e50726f706572747944657363726970746f7228652c69293a6e756c6c3b63262628632e6765747c7c632e736574293f4f626a6563742e646566696e6550726f7065727479286f2c692c63293a6f5b695d3d655b695d7d72657475726e206f2e64656661756c743d652c6e26266e2e73657428652c6f292c6f7d66756e6374696f6e20612865297b2240626162656c2f68656c70657273202d20747970656f66223b72657475726e28613d2266756e6374696f6e223d3d747970656f662053796d626f6c26262273796d626f6c223d3d747970656f662053796d626f6c2e6974657261746f723f66756e6374696f6e2865297b72657475726e20747970656f6620657d3a66756e6374696f6e2865297b72657475726e206526262266756e6374696f6e223d3d747970656f662053796d626f6c2626652e636f6e7374727563746f723d3d3d53796d626f6c262665213d3d53796d626f6c2e70726f746f747970653f2273796d626f6c223a747970656f6620657d292865297d66756e6374696f6e206928297b72657475726e20693d4f626a6563742e61737369676e7c7c66756e6374696f6e2865297b666f722876617220743d313b743c617267756d656e74732e6c656e6774683b742b2b297b766172206e3d617267756d656e74735b745d3b666f7228766172207220696e206e294f626a6563742e70726f746f747970652e6861734f776e50726f70657274792e63616c6c286e2c7229262628655b725d3d6e5b725d297d72657475726e20657d2c692e6170706c7928746869732c617267756d656e7473297d66756e6374696f6e206328652c742c6e297b72657475726e207420696e20653f4f626a6563742e646566696e6550726f706572747928652c742c7b76616c75653a6e2c656e756d657261626c653a21302c636f6e666967757261626c653a21302c7772697461626c653a21307d293a655b745d3d6e2c657d66756e6374696f6e207528652c74297b69662821286520696e7374616e63656f66207429297468726f77206e657720547970654572726f72282243616e6e6f742063616c6c206120636c61737320617320612066756e6374696f6e22297d66756e6374696f6e206c28652c74297b666f7228766172206e3d303b6e3c742e6c656e6774683b6e2b2b297b76617220723d745b6e5d3b722e656e756d657261626c653d722e656e756d657261626c657c7c21312c722e636f6e666967757261626c653d21302c2276616c756522696e2072262628722e7772697461626c653d2130292c4f626a6563742e646566696e6550726f706572747928652c722e6b65792c72297d7d66756e6374696f6e207328652c742c6e297b72657475726e207426266c28652e70726f746f747970652c74292c6e26266c28652c6e292c657d66756e6374696f6e206628652c74297b6966282266756e6374696f6e22213d747970656f66207426266e756c6c213d3d74297468726f77206e657720547970654572726f72282253757065722065787072657373696f6e206d75737420656974686572206265206e756c6c206f7220612066756e6374696f6e22293b652e70726f746f747970653d4f626a6563742e63726561746528742626742e70726f746f747970652c7b636f6e7374727563746f723a7b76616c75653a652c7772697461626c653a21302c636f6e666967757261626c653a21307d7d292c7426267028652c74297d66756e6374696f6e207028652c74297b72657475726e28703d4f626a6563742e73657450726f746f747970654f667c7c66756e6374696f6e28652c74297b72657475726e20652e5f5f70726f746f5f5f3d742c657d2928652c74297d66756e6374696f6e20642865297b76617220743d7928293b72657475726e2066756e6374696f6e28297b766172206e2c723d6d2865293b69662874297b766172206f3d6d2874686973292e636f6e7374727563746f723b6e3d5265666c6563742e636f6e73747275637428722c617267756d656e74732c6f297d656c7365206e3d722e6170706c7928746869732c617267756d656e7473293b72657475726e206828746869732c6e297d7d66756e6374696f6e206828652c74297b72657475726e21747c7c226f626a65637422213d3d6128742926262266756e6374696f6e22213d747970656f6620743f762865293a747d66756e6374696f6e20762865297b696628766f696420303d3d3d65297468726f77206e6577205265666572656e63654572726f72282274686973206861736e2774206265656e20696e697469616c69736564202d2073757065722829206861736e2774206265656e2063616c6c656422293b72657475726e20657d66756e6374696f6e207928297b69662822756e646566696e6564223d3d747970656f66205265666c6563747c7c215265666c6563742e";
        ByteBuf byteBuf = ByteBufUtil.toByteBuf(ByteBufUtil.toBytes(hex));
        //ipv4Packet
        Ipv4Packet ipv4Packet1 = Ipv4Packet.decodeMark(byteBuf);
        System.out.println(String.format("0x%x", ipv4Packet1.getChecksum()));
        TcpPacket tcpPacket = TcpPacket.decodeMark(ipv4Packet1.getPayload());

        //ipLayerPacket
        IpLayerPacket ipLayerPacket = new IpLayerPacket(byteBuf);
        ByteBuf rebuild = ipLayerPacket.rebuild();
        Ipv4Packet ipv4Packet2 = Ipv4Packet.decodeMark(rebuild);
        System.out.println(String.format("0x%x", ipv4Packet2.getChecksum()));

        //equals
        String hexStr = HexUtil.encodeHexStr(ByteBufUtil.toBytes(rebuild));
        boolean equals = hexStr.equals(hex);
        System.out.println();
    }

    @Test
    public void tcpudpQuadruplet() {
        String hex = "45000af088a740003b061d3ec0a80d59c0de0043" +
                "7977c4078e566a838c71be2f501000169a050000" +
                "4e2229282249455f50524f544f22292c633d66756e6374696f6e28297b7d2c753d66756e6374696f6e28297b76617220652c743d6e28226a68786622292822696672616d6522292c723d612e6c656e6774683b666f7228742e7374796c652e646973706c61793d226e6f6e65222c6e28226430373522292e617070656e644368696c642874292c742e7372633d226a6176617363726970743a222c653d742e636f6e74656e7457696e646f772e646f63756d656e742c652e6f70656e28292c652e777269746528223c7363726970743e646f63756d656e742e463d4f626a6563743c5c2f7363726970743e22292c652e636c6f736528292c753d652e463b722d2d3b2964656c65746520752e70726f746f747970655b615b725d5d3b72657475726e207528297d3b652e6578706f7274733d4f626a6563742e6372656174657c7c66756e6374696f6e28652c74297b766172206e3b72657475726e206e756c6c213d3d653f28632e70726f746f747970653d722865292c6e3d6e657720632c632e70726f746f747970653d6e756c6c2c6e5b695d3d65293a6e3d7528292c766f696420303d3d3d743f6e3a6f286e2c74297d7d2c22382b2b2f223a66756e6374696f6e28652c742c6e297b2275736520737472696374223b66756e6374696f6e20722865297b72657475726e2065213d3d657d652e6578706f7274733d727d2c22382f4552223a66756e6374696f6e28652c742c6e297b2275736520737472696374223b66756e6374696f6e20722865297b6966282266756e6374696f6e22213d747970656f66205765616b4d61702972657475726e206e756c6c3b76617220743d6e6577205765616b4d61702c6e3d6e6577205765616b4d61703b72657475726e28723d66756e6374696f6e2865297b72657475726e20653f6e3a747d292865297d66756e6374696f6e206f28652c74297b69662821742626652626652e5f5f65734d6f64756c652972657475726e20653b6966286e756c6c3d3d3d657c7c226f626a65637422213d747970656f66206526262266756e6374696f6e22213d747970656f6620652972657475726e7b64656661756c743a657d3b766172206e3d722874293b6966286e26266e2e6861732865292972657475726e206e2e6765742865293b766172206f3d7b7d2c613d4f626a6563742e646566696e6550726f706572747926264f626a6563742e6765744f776e50726f706572747944657363726970746f723b666f7228766172206920696e2065296966282264656661756c7422213d3d6926264f626a6563742e70726f746f747970652e6861734f776e50726f70657274792e63616c6c28652c6929297b76617220633d613f4f626a6563742e6765744f776e50726f706572747944657363726970746f7228652c69293a6e756c6c3b63262628632e6765747c7c632e736574293f4f626a6563742e646566696e6550726f7065727479286f2c692c63293a6f5b695d3d655b695d7d72657475726e206f2e64656661756c743d652c6e26266e2e73657428652c6f292c6f7d66756e6374696f6e20612865297b2240626162656c2f68656c70657273202d20747970656f66223b72657475726e28613d2266756e6374696f6e223d3d747970656f662053796d626f6c26262273796d626f6c223d3d747970656f662053796d626f6c2e6974657261746f723f66756e6374696f6e2865297b72657475726e20747970656f6620657d3a66756e6374696f6e2865297b72657475726e206526262266756e6374696f6e223d3d747970656f662053796d626f6c2626652e636f6e7374727563746f723d3d3d53796d626f6c262665213d3d53796d626f6c2e70726f746f747970653f2273796d626f6c223a747970656f6620657d292865297d66756e6374696f6e206928297b72657475726e20693d4f626a6563742e61737369676e7c7c66756e6374696f6e2865297b666f722876617220743d313b743c617267756d656e74732e6c656e6774683b742b2b297b766172206e3d617267756d656e74735b745d3b666f7228766172207220696e206e294f626a6563742e70726f746f747970652e6861734f776e50726f70657274792e63616c6c286e2c7229262628655b725d3d6e5b725d297d72657475726e20657d2c692e6170706c7928746869732c617267756d656e7473297d66756e6374696f6e206328652c742c6e297b72657475726e207420696e20653f4f626a6563742e646566696e6550726f706572747928652c742c7b76616c75653a6e2c656e756d657261626c653a21302c636f6e666967757261626c653a21302c7772697461626c653a21307d293a655b745d3d6e2c657d66756e6374696f6e207528652c74297b69662821286520696e7374616e63656f66207429297468726f77206e657720547970654572726f72282243616e6e6f742063616c6c206120636c61737320617320612066756e6374696f6e22297d66756e6374696f6e206c28652c74297b666f7228766172206e3d303b6e3c742e6c656e6774683b6e2b2b297b76617220723d745b6e5d3b722e656e756d657261626c653d722e656e756d657261626c657c7c21312c722e636f6e666967757261626c653d21302c2276616c756522696e2072262628722e7772697461626c653d2130292c4f626a6563742e646566696e6550726f706572747928652c722e6b65792c72297d7d66756e6374696f6e207328652c742c6e297b72657475726e207426266c28652e70726f746f747970652c74292c6e26266c28652c6e292c657d66756e6374696f6e206628652c74297b6966282266756e6374696f6e22213d747970656f66207426266e756c6c213d3d74297468726f77206e657720547970654572726f72282253757065722065787072657373696f6e206d75737420656974686572206265206e756c6c206f7220612066756e6374696f6e22293b652e70726f746f747970653d4f626a6563742e63726561746528742626742e70726f746f747970652c7b636f6e7374727563746f723a7b76616c75653a652c7772697461626c653a21302c636f6e666967757261626c653a21307d7d292c7426267028652c74297d66756e6374696f6e207028652c74297b72657475726e28703d4f626a6563742e73657450726f746f747970654f667c7c66756e6374696f6e28652c74297b72657475726e20652e5f5f70726f746f5f5f3d742c657d2928652c74297d66756e6374696f6e20642865297b76617220743d7928293b72657475726e2066756e6374696f6e28297b766172206e2c723d6d2865293b69662874297b766172206f3d6d2874686973292e636f6e7374727563746f723b6e3d5265666c6563742e636f6e73747275637428722c617267756d656e74732c6f297d656c7365206e3d722e6170706c7928746869732c617267756d656e7473293b72657475726e206828746869732c6e297d7d66756e6374696f6e206828652c74297b72657475726e21747c7c226f626a65637422213d3d6128742926262266756e6374696f6e22213d747970656f6620743f762865293a747d66756e6374696f6e20762865297b696628766f696420303d3d3d65297468726f77206e6577205265666572656e63654572726f72282274686973206861736e2774206265656e20696e697469616c69736564202d2073757065722829206861736e2774206265656e2063616c6c656422293b72657475726e20657d66756e6374696f6e207928297b69662822756e646566696e6564223d3d747970656f66205265666c6563747c7c215265666c6563742e";
        ByteBuf byteBuf = ByteBufUtil.toByteBuf(ByteBufUtil.toBytes(hex));
        IpLayerPacket ipLayerPacket = new IpLayerPacket(byteBuf);
        String srcIP = ipLayerPacket.getSrcIP();
        String dstIP = ipLayerPacket.getDstIP();
        int srcPort = ipLayerPacket.getSrcPort();
        int dstPort = ipLayerPacket.getDstPort();
        String identifier = ipLayerPacket.getIdentifier();
        System.out.println();
    }

    @Test
    public void tcpudp() {
        {
            String send = "45000034b65a40008006b557c0de0042c0a80d49" +
                    "e04818eb3551118f000000008002faf0a4f90000020405b40103030801010402";
            ByteBuf byteBuf = ByteBufUtil.toByteBuf(ByteBufUtil.toBytes(send));
            IpLayerPacket ipLayerPacket = new IpLayerPacket(byteBuf);
            String identifier = ipLayerPacket.getIdentifier();
            System.out.println("send: " + identifier);
        }
        {
            String recv = "45000034000040003c06afb2c0a80d49c0de0042" +
                    "18ebe048f64e23ba355111908012a564e0680000020405b4010104020103030b";
            ByteBuf byteBuf = ByteBufUtil.toByteBuf(ByteBufUtil.toBytes(recv));
            IpLayerPacket ipLayerPacket = new IpLayerPacket(byteBuf);
            String identifier = ipLayerPacket.getIdentifier();
            System.out.println("recv: " + identifier);
        }
        System.out.println();
    }

    @Test
    public void icmp() {
        {
            String hex = "45000054eb2500008001cd1dc0de0042c0de0067" +
                    "0000107530b000006740551e0004177508090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f3031323334353637";
            ByteBuf byteBuf = ByteBufUtil.toByteBuf(ByteBufUtil.toBytes(hex));
            IpLayerPacket ipLayerPacket = new IpLayerPacket(byteBuf);
            String identifier = ipLayerPacket.getIdentifier();
            System.out.println("hex: " + identifier);
        }
        {
            String send = "4500003cb11700008001f990c0de0042c0a80e50" +
                    "08004b200100013c6162636465666768696a6b6c6d6e6f7071727374757677616263646566676869";
            ByteBuf byteBuf = ByteBufUtil.toByteBuf(ByteBufUtil.toBytes(send));
            IpLayerPacket ipLayerPacket = new IpLayerPacket(byteBuf);
            String identifier = ipLayerPacket.getIdentifier();
            System.out.println("send: " + identifier);
        }
        {
            String recv = "4500003ce84b00003c01065dc0a80e50c0de0042" +
                    "000053200100013c6162636465666768696a6b6c6d6e6f7071727374757677616263646566676869";
            ByteBuf byteBuf = ByteBufUtil.toByteBuf(ByteBufUtil.toBytes(recv));
            IpLayerPacket ipLayerPacket = new IpLayerPacket(byteBuf);
            String identifier = ipLayerPacket.getIdentifier();
            System.out.println("recv: " + identifier);
        }
        System.out.println();
    }
}
